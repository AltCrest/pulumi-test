# main.yaml (OIDC-enabled version)

name: main

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  pulumi-up:
    name: pulumi-up
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ... (Node.js and Install steps remain the same) ...

      - uses: pulumi/actions@v5
        with:
          # Note: Changed command to 'up' for a typical deployment
          command: up
          stack-name: Stacks / static-website-aws-typescript / dev
          work-dir: ./stacks/static-website-aws-typescript
        env:
          # This is still required to authenticate to Pulumi Cloud
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

          # ------------------------------------------------------------------
          # ðŸ›‘ IMPORTANT CHANGE: These secrets MUST be removed or commented out.
          # The credentials are now dynamically fetched via ESC OIDC.
          # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          # ------------------------------------------------------------------
